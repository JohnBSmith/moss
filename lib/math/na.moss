
begin
global pli, inv, diffh, integral

use math: nan, floor

function pli(x0,d,a)
  n = size(a)
  undefined = nan if n==0 else nan*a[0]
  return fn|x|
    k = int(floor((x-x0)/d))
    if k<0 or k+1>=n
      return undefined
    else
      return (a[k+1]-a[k])/d*(x-x0-k*d)+a[k]
    end
  end
end

function inv(f,x,a,b)
  a1 = a; b1 = b
  s = sgn(f(b)-f(a))
  if s==0 then s=1 end

  for k in 60
    m = (a+b)/2
    if s*(f(m)-x)<0
      a = m
    else
      b = m
    end
  end
  if abs(m-a1)<1E-8
    return nan
  elif abs(m-b1)<1E-8
    return nan
  else
    return m
  end
end

diff_tab = [
[1],
[-1/60,3/20,-3/4,0,3/4,-3/20,1/60],
[1/90,-3/20,3/2,-49/18,3/2,-3/20,1/90],
[-7/240,3/10,-169/120,61/30,0,-61/30,169/120,-3/10,7/240],
[7/240,-2/5,169/60,-122/15,91/8,-122/15,169/60,-2/5,7/240],
[139/12096,-121/756,3125/3024,-3011/756,33853/4032,-1039/126,0,
 1039/126,-33853/4032,3011/756,-3125/3024,121/756,-139/12096],
[-139/12096,121/630,-3125/2016,3011/378,-33853/1344,1039/21,-44473/720,
 1039/21,-33853/1344,3011/378,-3125/2016,121/630,-139/12096]
]

function diff_rec(f,x,n,h)
  if n<7
    a = diff_tab[n]
    m = size(a)//2
    return (-m..m).sum(|k| a[m+k]*f(x+k*h))/h^n
  else
    return diff_rec(|x| diff_rec(f,x,6,h),x,n-6,h)
  end
end

function tab_diff(h)
  return fn diff|f,x,n|
    if n==0
      return f(x)
    else
      return diff_rec(f,x,n,h^(1/n))
    end
  end
end

function diffh(argm={})
  {h=0.001,order=false,fast=false} = argm
  if order
    return tab_diff(h)
  elif fast
    return fn diff|f,x|
      return (f(x+h)-f(x-h))/(2*h)
    end
  else
    return fn diff|f,x|
      return (f(x-2*h)-8*f(x-h)+8*f(x+h)-f(x+2*h))/(12*h)
    end
  end
end


GL32 = [
  [-0.9972638618494816, 0.007018610009470141],
  [-0.9856115115452684, 0.01627439473090563],
  [-0.9647622555875064, 0.02539206530926208],
  [-0.9349060759377397, 0.03427386291302148],
  [-0.8963211557660522, 0.04283589802222668],
  [-0.8493676137325699, 0.05099805926237622],
  [-0.7944837959679425, 0.05868409347853551],
  [-0.7321821187402897, 0.06582222277636184],
  [-0.6630442669302152, 0.07234579410884850],
  [-0.5877157572407623, 0.07819389578707028],
  [-0.5068999089322295, 0.08331192422694673],
  [-0.4213512761306354, 0.08765209300440380],
  [-0.3318686022821277, 0.09117387869576390],
  [-0.2392873622521371, 0.09384439908080457],
  [-0.1444719615827965, 0.09563872007927489],
  [-0.04830766568773831,0.09654008851472778],
  [ 0.04830766568773831,0.09654008851472778],
  [ 0.1444719615827965, 0.09563872007927489],
  [ 0.2392873622521371, 0.09384439908080457],
  [ 0.3318686022821277, 0.09117387869576390],
  [ 0.4213512761306354, 0.08765209300440380],
  [ 0.5068999089322295, 0.08331192422694673],
  [ 0.5877157572407623, 0.07819389578707028],
  [ 0.6630442669302152, 0.07234579410884850],
  [ 0.7321821187402897, 0.06582222277636184],
  [ 0.7944837959679425, 0.05868409347853551],
  [ 0.8493676137325699, 0.05099805926237622],
  [ 0.8963211557660522, 0.04283589802222668],
  [ 0.9349060759377397, 0.03427386291302148],
  [ 0.9647622555875064, 0.02539206530926208],
  [ 0.9856115115452684, 0.01627439473090563],
  [ 0.9972638618494816, 0.007018610009470141]
]

function integral(a,b,f,n=1)
  h = (b-a)/n
  p = 0.5*h
  s = 0
  for j in 0..n-1
    q = p+a+j*h
    sj = 0
    for t in GL32
      sj += t[1]*f(p*t[0]+q)
    end
    s += p*sj
  end
  return s
end

end




